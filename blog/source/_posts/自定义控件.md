---
title: 自定义控件
date: 2017-03-20 14:58:21
tags:
- 笔记
- view
categories:
- 笔记
- 自定义view
---
# 自定义控件学习笔记

## measure

ViewGroup 中measureChildWithMargins 调用 View的measure()
```java
protected void measureChildWithMargins(View child,
            int parentWidthMeasureSpec, int widthUsed,
            int parentHeightMeasureSpec, int heightUsed) {
               //获取child的LayoutParams
        final MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();

        final int childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,
                mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin + widthUsed,
                lp.width);
        final int childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,
                mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin + heightUsed,
                lp.height);
                //调用child的measure方法
        child.measure(childWidthMeasureSpec, childHeightMeasureSpec);
    }
```
其中getChildMeasureSpeac(int spec, int padding, int childDimension)
```java
public static int getChildMeasureSpec(int spec, int padding, int childDimension) {
       //获取ViewGroup的参数
       int specMode = MeasureSpec.getMode(spec);
       int specSize = MeasureSpec.getSize(spec);
       //获取可以使用的最大的size
       int size = Math.max(0, specSize - padding);

       int resultSize = 0;
       int resultMode = 0;

       //根据父控件的specMode分配子空间的大小 和 方式
       switch (specMode) {
       case MeasureSpec.EXACTLY:
       //childDimension是child的具体设置高度 如果<0则是match 或者 wrap
           if (childDimension >= 0) {
               resultSize = childDimension;
               resultMode = MeasureSpec.EXACTLY;
           } else if (childDimension == LayoutParams.MATCH_PARENT) {
               resultSize = size;
               resultMode = MeasureSpec.EXACTLY;
           } else if (childDimension == LayoutParams.WRAP_CONTENT) {
               resultSize = size;
               resultMode = MeasureSpec.AT_MOST;
           }
           break;

       case MeasureSpec.AT_MOST:
           if (childDimension >= 0) {
               resultSize = childDimension;
               resultMode = MeasureSpec.EXACTLY;
           } else if (childDimension == LayoutParams.MATCH_PARENT) {
               resultSize = size;
               resultMode = MeasureSpec.AT_MOST;
           } else if (childDimension == LayoutParams.WRAP_CONTENT) {
               resultSize = size;
               resultMode = MeasureSpec.AT_MOST;
           }
           break;

       // 一般不会使用 一般是listview中会使用这种方式
       case MeasureSpec.UNSPECIFIED:
           if (childDimension >= 0) {
               resultSize = childDimension;
               resultMode = MeasureSpec.EXACTLY;
           } else if (childDimension == LayoutParams.MATCH_PARENT) {
               //View.sUseZeroUnspecifiedMeasureSpec=false always
               resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size;
               resultMode = MeasureSpec.UNSPECIFIED;
           } else if (childDimension == LayoutParams.WRAP_CONTENT) {
               resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size;
               resultMode = MeasureSpec.UNSPECIFIED;
           }
           break;
       }
       return MeasureSpec.makeMeasureSpec(resultSize, resultMode);
   }
```
| child\parent        | MeasureSpec.EXACTLY    |  MeasureSpec.AT_MOST   | MeasureSpec.UNSPECIFIED|
 | --------   | -----:   | :----: |
 | 香蕉        | $1      |   5    |
 | 苹果        | $1      |   6    |
 | 草莓        | $1      |   7    |
